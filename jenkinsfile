pipeline {
    agent any

    parameters {
        string(name: 'APP_ID', defaultValue: '', description: 'ID de la aplicación a consultar')
    }

    environment {
        DB_USER = 'usuario'
        DB_PASS = 'password'
        DB_NAME = 'almdevops'
        DB_HOST = 'localhost'
    }

    stages {
        stage('Obtener tipo de aplicación') {
            steps {
                script {
                    def tipoApp = sh(script: """
                        psql -U $DB_USER -h $DB_HOST -d $DB_NAME -t -c "SELECT a_t.app_type 
                        FROM app_general_properties a_g
                        JOIN app_directory a_d ON a_g.id_app_directory = a_d.id
                        JOIN app_type_directory a_t ON a_d.id_app_type_directory = a_t.id
                        WHERE a_g.id = '${params.APP_ID}'"
                    """, returnStdout: true).trim()
                    
                    echo "Tipo de aplicación: ${tipoApp}"
                    env.APP_TYPE = tipoApp
                }
            }
        }

        stage('Consultar propiedades de la aplicación') {
            steps {
                script {
                    def query = ""
                    if (env.APP_TYPE == "microservice") {
                        query = "SELECT * FROM app_general_properties agp JOIN microservice_properties_directory mpd ON agp.id_microservice_directory = mpd.id WHERE agp.id = '${params.APP_ID}'"
                    } else if (env.APP_TYPE == "was") {
                        query = "SELECT * FROM app_general_properties agp JOIN was_properties_directory wpd ON agp.id_was_directory = wpd.id WHERE agp.id = '${params.APP_ID}'"
                    } else if (env.APP_TYPE == "pims") {
                        query = "SELECT * FROM app_general_properties agp JOIN pims_properties_directory ppd ON agp.id_pims_directory = ppd.id WHERE agp.id = '${params.APP_ID}'"
                    } else if (env.APP_TYPE == "ddbb") {
                        query = "SELECT * FROM app_general_properties agp JOIN database_properties_directory dpd ON agp.id_ddbb_directory = dpd.id WHERE agp.id = '${params.APP_ID}'"
                    } else {
                        error "Tipo de aplicación no soportado: ${env.APP_TYPE}"
                    }

                    sh """
                        echo "Ejecutando consulta:"
                        echo "${query}"
                        psql -U $DB_USER -h $DB_HOST -d $DB_NAME -c "${query}"
                    """
                }
            }
        }
    }
}
